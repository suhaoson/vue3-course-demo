### 页面功能扩展：如何对 Vue.js 全栈项目做优雅扩展？

#### 为什么平台需要扩展功能

虽然运营搭建平台已经实现了核心功能，能满足大部分搭建需求，但是原有平台功能不是一成不变的。平台能长期运转，需要不停地维护迭代和功能升级。
<br/>

一般，这种平台扩展的功能是五花八门的，很多情况下，我们都是根据实际使用时遇到的问题，扩展对应的功能来解决问题。所以完成核心功能，并不意味着项目平台的开发就结束了。还要对系统持续迭代拓展功能来适应新的业务场景。
<br/>

如果是从 0 到 1 开发，就没有那么多顾虑；但是如果在已有的平台上拓展功能，机会涉及到很多业务逻辑和技术环节。需要具体问题具体我分析。

<br/>

#### 如何开展功能页面扩展工作

大多数问题由于开发页面，核心的问题就是没有统一的规范。<br/>
<b>只要规范能达成共识，对于项目的规范遵守内容，我们就需要“规范的约束力”来运作。</b>

#### 如何设计搭建平台的页面扩展规范

“扩展规范”，需要结合搭建平台的业务和技术的内容特点，那我们设计扩展规范的第一步就是梳理平台特点。

##### 业务层面分析

先从业务内容特点开始。梳理业务，一般最便捷的方式，就是先找个维度切入，然后展开梳理。
<br/>
从用户角度分析，分成了前台页面和后台页面
![](https://static001.geekbang.org/resource/image/35/c1/35ac50c7c70228360ec92568f1c7ecc1.jpg?wh=4000x2517)

前台页面，是搭建完成的页面，提供给外部客户使用，每个页面都是独立的 URL 路径，而且必须支持 SEO，方便搜索引擎爬取数据。<br/>
SSR
<br/>

后台页面，很多是功能聚合型的操作，一个功能链路需要切换多张页面。后台页面需要支持服务端路由和浏览器路由的结合渲染。<br/>
<br/>
总结一下，<b>后台页面的扩展，必须能优雅配置是否需要登录态、能优雅选择是否服务端渲染，以及能优雅选择多页面或者单页面应用方式。</b>

##### 技术层面分析

技术分析图：

![](https://static001.geekbang.org/resource/image/40/68/40c08f62b997d152377bfd8816158c68.jpg?wh=4000x2250)
![](https://static001.geekbang.org/resource/image/c7/y3/c7acfd45eab6aff4e19b683b68d3byy3.jpg?wh=4000x2250)

然后我们根据业务特点和技术分析，归纳所需要的技术点。<br/>

- 前端页面渲染技术点：单页面应用、浏览器路由。
- 服务端页面渲染技术点：服务端路由、用户权限判断、处理页面 HTML。

<br/>
我们进一步对业务和技术内容分层。
<br/>

- 前端层面：浏览器多级路由层、多级子页面管理层。
- 服务端层面：服务端多级路由层、路由权限状态层、服务端渲染页面层。
  <br/>

对于服务端层面的多级服务端路由来说，我们可以定义多级路由。但是，路由不能随便定义，要确定好服务端多级路由规范。

```
## 一级页面路由
/page

## 二级页面路由
/page/manage

## 三级页面路由
/page/manage/material

## 四级页面路由
/page/manage/material/item
```

<br/>
在多级路由例子里，我们可以从“/page”这一级路由开始。拓展角度，确保页面都是/page/这个路径前缀进行分享的。
<br/>
<b>路由这个层面的设计要尽量简约，服务端扩展到第二级路径就好，往后层级保留给前端的浏览器路由使用。</b>
<br/>

示例图：
![](https://static001.geekbang.org/resource/image/82/f2/829933f6c642aa3afe37a726f5b0e8f2.jpg?wh=4000x2415)

综合约定了页面的路由扩展规范，接下来就是路由层往后的扩展，服务端需要的是权限控制，基于 Koa.js 的 Web 服务，我们可以利用 koa-router 路由中间件，做统一控制处理。<br/>

```
// packages/work-server/src/router.ts

import Router from '@koa/router';
const router = new Router();
// 其它代码 ...

// checkAccountOnlineStatus 方法是检查账号是否有在线登录态
// renderPage 方法是渲染页面
router.get('/page/:pageName', checkAccountOnlineStatus, renderPage);

// 只有checkAccountOnlineStatus验证状态通过后，
// 才能进入renderPage渲染页面

// 其它代码 ...
```

<br/>
完成了路由和权限的规范设计，剩下的就是页面内容的扩展，这个在服务端层面和前端层面比较类似。

- 对于服务端来说，比较简单，就是 HTML 页面字符串的处理，我们可以基于 Vue.js 的 CommonJS 模块进行渲染，或者直接拼接字符串输出。
- 对于前端来说，要考虑基于 vue-router 的子路由，也就是前端层面多级路由扩展。我们可以根据业务的归属层次，进行浏览器端的子路由注册，以及子路由背后对应的 Vue.js 组件的渲染。

![](https://static001.geekbang.org/resource/image/1a/cc/1a9580172dbcyyed0cd6ca61307d4bcc.jpg?wh=4000x2415)

#### 如何实现项目页面扩展的技术底座

回顾课程全栈项目的代码结构，如果你细心的话就会发现，我们课程搭建平台一开始的项目代码就是一个天然的技术底座。
<br/>
以后台服务端的代码结构为例。服务端底座层面，以路由作为切入点，扩展一个新的路径前缀，就支持对应的路由注册。接着，再扩展新的服务端渲染 HTML 模板，以及控制层渲染方法。
<br/>

![](https://static001.geekbang.org/resource/image/61/e6/61f0c95965323b06c6cb42a230880de6.png?wh=1920x1091)
这张截图，就展示了后台预览搭建结果渲染页面，扩展了三种不同环境的预览页面路径以及服务端渲染方法。
<br/>

服务端扩展页面就从路由、渲染模板和控制层渲染方法这三个环节来扩展处理。
<br/>

我们课程全栈项目的前端代码，也是从技术底座的视角来设计的。<br/>
![](https://static001.geekbang.org/resource/image/0c/b5/0c110c6cfc629yy106f529e9d01af9b5.png?wh=1920x1291)
这张截图是后台的前端子项目代码结构，你可以直接理解成单页面应用扩展的前端技术底座。扩展单页面应用是按照目录结构进行的，可以直接对比路由的多级路径，方便开发者扩展页面操作（更多技术底座的代码内容，可以查看完整代码![](../main/）。

#### 课程的页面扩展和微前端有什么区别

前端页面的设计和实现内容，整个页面扩展过程，跟“微前端”的技术场景确实很像。其实，课程前端页面扩展，单纯从扩展页面的技术视角上看，你也可以理解成一种“微前端”的形式。<br/>

不过跟实际的微前端还是有很大区别的，主要表现是解决问题的场景不同。
<br/>
<b>在企业项目开发中， 微前端侧重解决多技术体系页面的聚合问题。</b><br/>
<b>课程的页面扩展内容，要解决的问题是对已有项目，如何有规范地扩展页面功能</b><br/>
总之，要解决业务问题或需求，我们不能单纯靠堆技术框架完成功能，而是要根据项目现状，分析特点，设计合适的技术规范，实现功能。同时，还要避免滥用技术框架，避免出现过度技术设计的情况，导致维护成本剧增。
<br/>

> 此文章为 4 月 Day3 学习笔记，内容来源于极客时间《Vue 3 企业级项目实战课》，学习使我快乐，每天进步一点点 💪💪
