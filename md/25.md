### 后台搭建功能：如何设计和实现 Vue.js 运营后台的搭建功能？

在“运营搭建平台”一节的功能分析中，我们把平台功能分成三大功能维度，“用户维度”“物料维度”和“页面维度”。<br/>
页面功能维度可以分成五大功能模块，“页面搭建”“页面编译和运行”“页面发布流程”“页面版本管理”和“页面渲染方式”。<br/>

#### 如何设计页面搭建的数据格式

之前我们说过，页面是由物料组成的，物料是由 Vue.js 组件和数据源组成的，而数据源构成页面的数据结构。<br/>
底层构成元素就是“数据”和“静态资源”。
<br/>
不过设计搭建页面的数据格式之前，我们要先对页面布局结构做设计。<br/>

1. 首先，我们要做“布局规范”的选择。页面布局规范有很多种，比如<b>网格布局</b>、绝对定位布局、流式布局等等。<br/>
2. 接下来就是要做布局的数据设计了。<br/>
   示意图：
   ![](https://static001.geekbang.org/resource/image/3e/3c/3e683322562d641973a92e31e36d993c.jpg?wh=1920x1080)
   <br/>

我们可以基于 TypeScript 来设计页面布局数据格式。

```
 // 列布局
interface LayoutColumn {
  name?: string;
}

// 行布局
interface LayoutRow {
  columns: LayoutColumn[];
}

// 布局
interface Layout {
  rows: LayoutRow[];
}
```

3. 设计了布局的基本数据格式后，还要考虑布局尺寸问题。<br/>
   在网格布局中，页面的每一行高度，我们可以根据列布局中物料的高度弹性变化，但是页面的宽度就要做限制。每一行的宽度，受到顶级布局宽度的限制，带动着行里的每一列就要分割限制的宽度。<br/>
   布局数据的 TypeScript 数据类型可以扩展添加宽度属性。

```
// 列布局
interface LayoutColumn {
  name?: string;
  width: string | number;
}

// 行布局
interface LayoutRow {
  columns: LayoutColumn[];
}

// 布局
interface Layout {
  width: number | string;
  rows: LayoutRow[];
}
```

4. 现在我们有了完整的布局数据格式，接下来就要把物料填充到网格布局中的每一列中。
   <br/>

在“列数据”中添加“物料数据”，会导致整个“页面布局数据”的数据层级太多;避免实际的 JSON“数据层级”太深；我们在每一个列数据中留下一个 uuid，代表每一个物料模块，然后在布局数据格式的同个层级中，定义一个模块的 Map 对象数据，来包含所有物料模块数据格式。模块 Map 对象数据的键值 Key 就是每列的 uuid，指向所引用的列。<br/>

模块数据可以这么设计，每个独立的物料模块中，包含了物料组件的名称，版本号和物料数据源。看具体的 TypeScript 代码。

```
// 物料模块
interface LayoutModule {
  materialName: string;
  materialVersion: string;
  materialData: Record<string, any>; // 物料数据源
}

// 物料模块Map
interface LayoutModuleMap {
  [uuid: string]: LayoutModule; // uuid指向每一列里的uuid
}
```

完整的 TypeScript 数据类型代码：

```
// 列布局
interface LayoutColumn {
  uuid: string; // 列唯一的uuid，指向物料模块的uuid
  name?: string;
  width: string | number;
}

// 行布局
interface LayoutRow {
  uuid: string; // 行唯一的uuid
  columns: LayoutColumn[];
}

// 布局
interface Layout {
  width: number | string;
  rows: LayoutRow[];
}

// 物料模块
interface LayoutModule {
  materialName: string;
  materialVersion: string;
  materialData: Record<string, any>; // 物料数据源
}

// 物料模块Map
interface LayoutModuleMap {
  [uuid: string]: LayoutModule;
}

// 完整的页面布局数据
interface PageLayoutData {
  layout: Layout;
  moduleMap: LayoutModuleMap;
}
```

基于这段完整的页面布局数据的 TypeScript 类型，我来实现一个页面搭建的 JSON 对象数据例子。

```

{
  "layout": {
    "rows": [
      {
        "uuid": "7a3dbfa7-29ca-4765-bd58-7a91abda7721",
        "columns": [
          {
            "name": "其它广告位1",
            "uuid": "2be63a53-8a16-43ba-8640-a1ab24bdbae3",
            "width": 600
          },
          {
            "name": "其它广告位2",
            "uuid": "0184e8ed-7df4-4742-9bb4-b8dfa1a0aca7",
            "width": 400
          }
        ]
      },
      {
        "uuid": "0fdbe663-51d8-4038-9d0d-bdeed0c6eb71",
        "columns": [
          {
            "name": "促销商品模块",
            "uuid": "26148a93-e66a-4448-b6a4-4bddbce9ae4f",
            "width": 1000
          }
        ]
      }
    ],
    "width": 1000
  },
  "moduleMap": {
    "26148a93-e66a-4448-b6a4-4bddbce9ae4f": {
      "materialData": {},
      "materialName": "@my/material-product-list",
      "materialVersion": "0.9.0"
    },
    "2be63a53-8a16-43ba-8640-a1ab24bdbae3": {
      "materialData": {},
      "materialName": "@my/material-banner-slides",
      "materialVersion": "0.9.0"
    },
    "0184e8ed-7df4-4742-9bb4-b8dfa1a0aca7": {
      "materialData": {},
      "materialName": "@my/material-banner-slides",
      "materialVersion": "0.9.0"
    }
  }
}
```

<b>页面搭建的实现原理，就是要基于“搭建页面数据”，再结合“物料组件资源”，也就是物料的 JavaScript 和 CSS 静态资源文件，来完成页面的搭建功能。</b>
<br/>

#### 如何设计页面搭建的功能链路

从页面布局数据的分析步骤可以看出，实现一个搭建的页面，需要先制定页面的布局，然后再向布局中填充物料。所以页面搭建功能链路，就是从布局到物料的操作过程。
<br/>
![](https://static001.geekbang.org/resource/image/99/19/998971812faf706b418726a06185c619.jpg?wh=1920x1080)

<br/>
我们能很清晰地把页面搭建功能链路分成五个步骤。<br/>

- 第一步：操作页面的行列布局<br/>
  这一步，主要功能是支持添加“行布局”，在新增“行布局”时候，支持定义所在“行布局”中的“列布局”。包括了“列”的个数和每一列分割的宽度
  ![](https://static001.geekbang.org/resource/image/9b/0d/9b49187e91d80851e740416c87c9c60d.png?wh=1920x1451)
  ![](https://static001.geekbang.org/resource/image/d8/ee/d8f4bdd92f2d16ee841dd8cc37983dee.png?wh=1920x1451)
  <b>，“列”是整个页面布局中的最小单位，也就是说，最终物料是填充到“列布局”中的。</b>
- 第二步：填充物料模块到列布局中<br/>
  我们先进行物料的查询，查询验证成功后就填充到“列布局”中。具体操作界面就像这样。
  ![](https://static001.geekbang.org/resource/image/20/d9/20c635f45f9581781ba67884257a2dd9.png?wh=1920x1175)
  ![](https://static001.geekbang.org/resource/image/13/e0/1368fd24eae992d11444e13c194efae0.png?wh=1920x1247)
- 第三步：编辑物料的数据源<br/>
  在这个步骤中，支持对每一列中的物料模块，进行数据源的编辑。
  ![](https://static001.geekbang.org/resource/image/7d/ef/7db2424b3b6dd66d93e81c09322ee1ef.png?wh=1920x1356)
  ![](https://static001.geekbang.org/resource/image/06/5b/065ea15f70d376aff066306e2e0a6a5b.png?wh=1920x1356)
- 第四步：发布页面布局数据<br/>
  这一步也就是提交完整的页面布局数据（布局和物料模块数据），存储到数据中，支持下次编辑。
  ![](https://static001.geekbang.org/resource/image/42/11/425c3857feaf1db550c1d5097eced411.png?wh=1920x1067)
- 第五步：支持重新编辑页面布局数据<br/>
  这一步中，支持对已发布的页面数据进行重新修改，基本复用了上面的所有功能点，包括编辑行列布局、填充物料组件、编辑物料数据源和发布修改数据。
  ![](https://static001.geekbang.org/resource/image/ba/ce/bacd4dfe36d60559f25c7ef8599d86ce.png?wh=1920x2039)
  <br/>

#### 如何做页面搭建的技术方案设计

按照我们之前的套路，功能的技术方案设计，其实就是根据功能逻辑设计的步骤，对应找到合适的或者熟悉的技术实现方式。
<br/>

- 第一步，操作页面的行列布局。<br/>
  - 这一步骤中，主要是实现布局的操控。首先，是“行布局”的操控，我们可以基于 Vue.js 的响应式数据来实现“行布局”的“增删改”操作。然后是“列布局”的定义，我们在行布局的新增时候，就可以用动态表单来实现对应“列布局”的宽度定义。<br>
  - 也可以是用之前小节中实现的的“拖拽布局组件”来支持“列布局”的位置拖拽。
    ![](https://static001.geekbang.org/resource/image/9c/8d/9cfb451bbc6624ae4fae681df565ce8d.gif?wh=599x279)
- 第二步，填充物料模块到“列”布局中。

  - 这个要用到之前小节中实现的组件库相关的“对话框组件”和“动态表单组件”。
  - 今天的代码案例中，我已经改造了“对话框组件”，让它支持渲染嵌套子组件。最终技术逻辑是弹出一个对话框，嵌套一个动态表单来进行填充物料。
    在代码案例中，选用了物料 Vue.js 组件的 AMD 模块，进行组件动态加载和动态渲染。主要是封装了一个动态渲染物料模块的 JSX 组件。

```
// packages/work-front/src/pages/manage/modules/page-editor.tsx
import * as Vue from 'vue';

// 动态初始化AMD 运行时环境
async function initAMDEnv(params: {
  materialName: string;
  materialVersion: string;
}) {
  const { materialName, materialVersion } = params;
  if (!window.requirejs) {
    await loadScript('/public/cdn/pkg/requirejs/2.3.6/require.js');
  }
  const paths: Record<string, string> = {};
  // 注册Vue的AMD模块，AMD和当前应用共用同一个Vue.js运行时
  window.define('vue', [], () => Vue);
  paths[materialName] = `/public/cdn/material/${materialName}/${materialVersion}/index.amd`;
  window.requirejs.config({
    paths
  });
}

// 创建动态物料预览模块 的 Vue.js组件
function createEditModule(params: {
  materialName?: string;
  materialVersion?: string;
  materialData?: any;
  // 省略其它参数...
}) {
  const { materialName, materialVersion, materialData } = params;
  // 物料挂载的 "外壳组件"
  const EditModule: DefineComponent = defineComponent({
    setup() {
      const container = ref<HTMLElement>();

      onMounted(async () => {
        if (!(materialName && materialVersion)) {
          return;
        }
        const params = {
          name: materialName,
          version: materialVersion
        };
        // 初始化 AMD 运行时环境
        await initAMDEnv({ materialName, materialVersion });
        // 加载物料样式
        await loadMaterialStyle(params);
        window.require( ['vue', materialName],
          (Vue: any, MaterialComponent: any) => {
            // 这里拿到的Vue是跟当前应用是同一个Vue.js运行时
            // 动态加载物料组件的AMD模块
            const App = Vue.h(MaterialComponent, materialData || {});
            const app = Vue.createApp(App, {});
            // 在"外壳组件"中动态挂载物料的AMD格式Vue.js组件
            app.mount(container.value);
          }
        );
      });
      // 中间省略其它代码 ....

      return () => {
        return (
          <div style={{ width }} class="module-page-edit-module">
            {/* 中间省略其它代码 ....   */}
            <div class="page-edit-module-content" ref={container}></div>
          </div>
        );
      };
    }
  });
  return EditModule;
}
```

- 第三步，编辑物料的数据源。
- 可以直接复用上节课编辑物料数据源的表单组件，结合对话框组件一起使用，实现动态获取数据源的 JSON Schema，动态渲染数据源表单，最后实现编辑数据源的功能。
- 第四步，发布页面布局数据。
- 这要开发对应的 HTTP 服务接口，支持提交数据到服务端，并且存储到数据库中。具体技术实现都是重复性的 SQL 操作和 Node.js 逻辑代码实现，可以复制修改之前物料操作的代码，对数据库中的页面数据进行“增改查”操作。
- 第五步，支持编辑页面布局数据。
- 这一步最简单，基于上述四个步骤实现的功能，添加默认数据填充和提交数据接口的修改。

#### 小结

1. 页面搭建过程中，对布局和物料的编辑等操作，会遇到大量表单场景，技术方案选择动态表单，能大大提高开发效率。
2. 拖拽技术不一定能适用所有页面搭建功能，要考虑到页面超长出现浏览器滚动场景，拖拽操作就体验不友好。
3. 页面布局操作，涉及大量的数据设计和数据操作，所以类似搭建项目，要尽量使用 TypeScript 进行开发，限制数据类型格式。

> 此文章为 3 月 Day26 学习笔记，内容来源于极客时间《Vue 3 企业级项目实战课》，学习使我快乐，每天进步一点点 💪💪
