### 后台搭建数据源：如何设计运营搭建页面的数据结构？

在运营搭建平台中，对物料进行资源和数据管理后，要怎么预览物料效果呢？<br/>
如果能预览物料效果，那能不能进一步自定义物料的效果，比如通过传入自定义的数据，来控制物料的显示内容或者操作功能？<br/>

#### 实现思路分析

我们需要用到的物料，其实就是 Vue.js 组件。<br/>
如果要让组件实现预览效果，可以直接把组件单独当做应用来运行。
<br/>

如果要自定义物料显示效果，就要做两方面支持：
<br/>

1. 一方面是物料的 Vue.js 组件在开发的时候，必须支持通过 Props 来自定义控制部分内容
2. 在组件运行的时候，支持通过 Props 传入自定义的数据，让物料组件根据代码逻辑，展现出自定义效果。

<br/>
同时，在同一个页面上，我们还可以多次使用同一物料的 Vue.js 组件，传入不同的 Props 数据，来重复使用同一个物料，达到不同的渲染效果。
<br/>

#### 什么是物料数据源

在我们课程的运营搭建平台项目里，“数据源”属于一种业务概念，指给物料提供自定义的数据，让物料根据组件里的代码逻辑，渲染自定义内容。也可以让同一个物料在同一个页面上使用复用多次，使用不同数据源来渲染不同的效果。
<br/>

为什么说“数据源”是“业务上的定义”呢？<br/>
因为它其实是项目开发者或者管理者在项目内部约定的一种业务概念。
<br/>

在我们课程的项目里，所有的“数据源”都是指“物料数据源”，用来给物料的 Vue.js 组件传入自定义数据的，就是单纯的 Vue.js 组件的 Props 配置数据，不会具体指哪种 HTTP 请求 API 类型。<b>这样方便我们以后按照“业务需求”，直接把配置数据，替换成实际的 HTTP 数据接口。</b>
<br/>
对数据源概念达成一致之后，接下来，我们来看看怎么设计数据源的“数据描述格式”。
<br/>
毕竟，不同功能的物料，背后实现的 Vue.js 组件是不一样的，那么组件的 Props 数据格式 也是不一样的。
<br/>

我们看一个实际的代码例子。<br/>
先看课程代码案例里的广告轮播物料组件 @my/material-banner-slides，Props 的 TypeScript 数据类型是这样子的。<br/>

```
export interface MaterialProps {
  width: number | string;
  height: number | string;
  banners: Array<{
    text: string;
    background: string;
  }>;
}
```

根据这个数据类型，具体传入自定义数据可以这么来定义。

```
{
  width: 600,
  height: 200,
  banners: [
    {
      text: '这是第1个轮播内容',
      background: '#66ded3'
    },
    {
      text: '这是第2个轮播内容',
      background: '#f5a991'
    }
  ]
}
```

渲染效果图就像下边：
![](https://static001.geekbang.org/resource/image/e8/90/e85c805193accbd0dd054bb44c4bbd90.png?wh=1774x822)
传入的数据源是 JSON 对象类型，实际搭建页面配置的物料数据源，也是把 JSON 数据存到数据中。<br/>
那么问题来了，不同物料的 JSON 数据是不一样的，总不能让运行搭建平台的用户在配置每个物料数据源的时候，都直接输入 JSON 数据吧？怎么办呢？
<br/>
其实，“输入 JSON 数据”就像“解答题”，我们可以通过<b>动态表单来生成 JSON 数据</b>，变成用户只需要<b>在表单上输入个别数据的“填空题”</b>。

<br/>
想要用动态表单来支持实现，提供表单的操作，支持不同 JSON 数据格式的编辑，也就意味着要把不同物料数据源的 JSON 数据格式进一步抽象，用统一的描述格式，来描述 JSON 数据格式。
<br>
引出JSON Schema 描述JSON数据格式的格式

#### 什么是 JSON Schema

从 JSON Schema 的官方网站 https://json-schema.org/ 我们可以看到介绍。
<br/>

> JSON Schema is a declarative language that allows you to annotate and validate JSON documents. JSON Schema enables the confident and reliable use of the JSON data format.
> <br/>

翻译过来就是，“JSON Schema 是一种声明式的语言，允许通过它进行注释和验证 JSON 文档。 JSON Schema 让 JSON 数据格式的使用变得可靠和确定。”简单讲，就是“用 JSON 来描述 JSON 格式”，或者是“JSON 数据的数据结构”。
<>br/
举个例子：第一个例子，一个 JSON 对象数据。

```
{
  "abc": 123
}
```

这个数据有一个属性“abc”，属性值为 123 的数字，用 JSON Schema 来描述的话就是这段代码。

```
{
  "type": "object",
  "properties": {
    "abc": {
      "type": "number"
    }
  },
  "$schema": "http://json-schema.org/draft-07/schema#"
}
```

这段代码就是 JSON Schema，它描述了一个 JSON 数据，拥有一个属性“abc”，属性值为数字，可以描述任何数字内容，不一定是具体的数字“123”。同时，JSON Schema 有个“$schema”属性，代表是基于 JSON Schema 的草案版本。
<br/>
第二个例子：

```
{
  abc: [1, 2, 3, 4]
}
```

这个数据有一个属性“abc”，属性值是“数字数组”，用 JSON Schema 来描述就是这段代码。

```
{
  "type": "object",
  "properties": {
    "abc": {
      "type": "array",
      "items": {
        "type": "number"
      }
    }
  },
  "$schema": "http://json-schema.org/draft-07/schema#"
}
```

这个 JSON Schema 描述一个 JSON 对象数据，有一个属性“abc”，类型为“数字数组”。
<br/>

我们再看一个更复杂的例子，这个代码里有“数组和对象嵌套”，也就是“对象数组格式”的 JSON 数据。

```
{
  abc: [
    { a: 1, b: 'hello', c: true },
    { a: 2, b: 'hello', c: false }
  ]
}
```

JSON Schema 可以描述成这样。

```
{
  "type": "object",
  "properties": {
    "abc": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "a": {
            "type": "number"
          },
          "b": {
            "type": "string"
          },
          "c": {
            "type": "boolean"
          }
        }
      }
    }
  },
  "$schema": "http://json-schema.org/draft-07/schema#"
}
```

这三个例子，就是大部分常见 JSON 数据的 JSON Schema 描述，更多使用方式你可以查看官方文档 [https://json-schema.org/](https://json-schema.org/) 。
<br/>

#### 如何自动生成数据源的数据结构

要自动生成物料数据源的 JSON Schema，就是要自动生成数据源的数据结构，核心就是基于物料 Vue.js 组件的 Props 类型描述。
<br/>
换句话说，就是要直接基于 Vue.js 组件中 Props 的 TypeScript 类型描述，自动生成 JSON Schema，来保证 JSON Schema 跟组件的 Vue.js 组件的 Props 数据类型描述的一致。避免物料数据源描述与 Vue.js 组件 Props TypeScript 类型割裂，而带来技术和业务功能的脱钩。
<br/>

方法就是 typescript-json-schema 这个 npm 模块，可以把指定的 TypeScript 数据类型，转成 JSON Schema。
<br/>

#### 如何实现物料数据源配置功能实现

技术方案如图：
![](https://static001.geekbang.org/resource/image/52/9b/52b9ce18de2b16ea1b00fefc2913f99b.jpg?wh=1920x1114)

可以看到“物料预览功能”的完整实现，需要依赖四个步骤。<br/>

- 第一步：生成物料数据源 JSON Schema。<br/>
  生成物料数据源 JSON Schema。就是物料开发阶段的 TypeScript 的类型文件，描述物料的 Vue.js 组件的 props 类型。
- 第二步：物料数据源 JSON Schema 和物料静态资源一起管理。<br/>
  物料数据源 JSON Schema 和物料静态资源一起管理。就是把独立的 JSON Schema 数据文件，跟随物料的 JavaScript 和 CSS 文件，发送到 CDN 或者私有 NPM 服务。
- 第三步：基于 JSON Schema 生成动态表单。<br/>
  浏览器会请求物料组件的 JSON Schema 文件，把 JSON 描述数据转成动态表单的字段数据，最后渲染出动态表单，给用户自定义数据配置使用。
- 第四步：把物料隔离渲染。<br/>
  我们把动态表单配置数据后，传入物料的 Vue.js 组件，让它运行自定义数据。

<br/>
同时，这里渲染物料 Vue.js 组件的时候，为了避免样式和全量变量干扰，我们就用 iframe 来隔离渲染组件，并且传入自定义的数据源数据。
<br/>
这是拼接物料 Vue.js 组件独立渲染的 HTML 内容。
<br/>

```
// packages/work-front/src/pages/manage/utils/srcdoc.ts
export function createIframeDocument(data: {
    name: string;
    version: string;
    props: any;
}): string {
    code...html
}
```

<br/>
最终结果传入 iframe 的 srcdoc 属性中，渲染动态子页面，达到隔离环境，独立渲染 Vue.js 组件的效果。看具体实现的核心功能代码。

```
<!-- packages/work-front/src/pages/manage/views/material-preview.vue -->
<template>
  <div class="view-material-preview">
    <div class="view-header">
      <div class="view-title">
        <span>预览物料：</span>
        <span>{{ model.name }} {{ model.currentVersion }}</span>
      </div>
    </div>
    <div class="view-content">
      <iframe class="preview-iframe" :srcdoc="iframeSrcDoc"></iframe>
    </div>
  </div>
</template>

<script lang="ts" setup>
import { Message } from '@my/components';
import { onMounted, reactive, ref } from 'vue';
import { useRoute } from 'vue-router';
import { createIframeDocument } from '../utils/srcdoc';

const route = useRoute();
const iframeSrcDoc = ref<string>('');

interface MaterialData {
  uuid: string;
  name: string;
  currentVersion: string;
  info: string;
  extend: string;
  createTime?: string;
  modifyTime?: string;
}
const model = reactive<MaterialData>({
  uuid: '',
  name: '',
  currentVersion: '',
  info: '',
  extend: ''
});

onMounted(() => {
  fetch(`/api/get/material/data?uuid=${route.query?.uuid}`)
    .then((res) => res.json())
    .then((result) => {
      Message.open({
        type: result.success ? 'success' : 'error',
        text: result.message,
        duration: 2000
      });
      if (result.data) {
        const data = result.data;
        model.uuid = data?.uuid;
        model.name = data?.name;
        model.currentVersion = data?.currentVersion;
        model.info = data?.info;
        model.extend = data?.extend;
      }
      iframeSrcDoc.value = createIframeDocument({
        name: model.name,
        version: model.currentVersion,
        props: {}
      });
    })
    .catch((err: Error) => {
      Message.open({
        type: 'error',
        text: `获取信息 [${err.toString()}]`,
        duration: 5000
      });
    });
});
</script>
```

最终效果就是这样。如图：
![](https://static001.geekbang.org/resource/image/af/50/affa05a609af8756df30536bfcc3bf50.png?wh=1920x1288)
点击图中物料编辑页面的“预览按钮”，进入物料效果的预览页面，可以自定义编辑物料的数据源。
![](https://static001.geekbang.org/resource/image/56/cb/5697832063852f28edc4816bea21afcb.png?wh=1920x1557)
![](https://static001.geekbang.org/resource/image/04/92/0442180db1e5742ef3ff75a410e82d92.png?wh=1920x1861)

> 此文章为 3 月 Day25 学习笔记，内容来源于极客时间《Vue 3 企业级项目实战课》，学习使我快乐，每天进步一点点 💪💪
