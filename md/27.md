### 后台发布流程：如何实现 Vue.js 搭建页面的发布流程？

我们运营搭建平台的下一步功能实现，就是发布页面了。
<br/>

#### 企业级的发布流程究竟是怎样的？

不同企业对技术产品的发布上线，有不同的发布流程规范，但是，这些发布流程的规范都是大同小异。经过梳理，我把企业级的发布流程抽象出四个基本规范点。
<br/>

- 有流程节点
- 有多环境隔离
- 发布内容一致性
- 发布操作有迹可循
  <br/>

具体展开了解：

##### 1. 有流程节点

第一点，有流程节点，是指发布流程要有明确的流程节点，而且是面向不同角色的流程节点。<br/>
一般大厂里，不论是任何技术代码的发布，还是搭建页面的发布，流程基本至少有三个节点，分别是开发测试节点、预发布节点和生产节点。
<br/>
开发测试节点:是面向程序员的，在这个节点中，程序员可以按照需要，修改代码，验证开发后的功能。<br/>
预发布节点:面向的角色是项目经理、产品经理等非开发人员，主要是作为功能验收使用。<br/>
生产节点:到了这个节点就是代码或者搭建页面上产线，给实际外部客户使用功能了。<br/>
![](https://static001.geekbang.org/resource/image/94/da/94dc4d2f2d3913919b8d97200f1f84da.jpg?wh=4000x2250)
<br/>

##### 2. 有多环境隔离

有多环境隔离，就是根据不同流程节点，对应不同环境，并且每个环境都是隔离的，互不干扰。<br/>
基于上面提到的三个流程节点，对应的环境就是测试环境、预发环境和生产环境。这里的环境是指独立的服务器，独立的数据；总之，核心是要隔离所有功能操作，避免流程之间的干扰。<br/>
![](https://static001.geekbang.org/resource/image/12/17/1211b4676d726d7fb36729e931949d17.jpg?wh=4000x2250)

##### 3. 发布内容一致性

发布内容一致性。这是指在执行发布流程操作的时候，从一个节点流转到下一个节点，要保证内容传递过去的是一样的。
<br/>
我们课程页面搭建的发布流程操作，搭建完的页面，要从测试环境流转到预发环境，也要保证页面的资源和数据，都原封不动地从测试环境迁移到预发环境。
<br/>
![](https://static001.geekbang.org/resource/image/bd/32/bdb9212fd85d792c7bfcc73de95a6c32.jpg?wh=4000x2250)

#### 4. 发布操作有迹可循

第四点发布操作有迹可循，就是指发布内容到生产环境的任何操作，都需要记录下来，保证有迹可循。这些记录可以为后续发布出问题，提供排查线索或者回滚数据。
<br/>
了解了发布流程的四个基础规范点，有流程节点、有多环境隔离、发布内容一致性、发布操作有迹可循，我们可以总结出企业中发布流程的作用，企业发布项目上线，要有流程规范，保证生产的安全和稳定。具体就是三方面。
<br/>

- 方便不同角色执行工作
- 规范不同角色生产操作
- 产线发布操作有迹可循

#### 如何设计搭建平台的发布流程？

从企业发布流程的基础规范，你可以看出，规范的核心要素有三个，发布内容、流程节点和节点环境。那么我们对运营搭建平台的发布流程设计，就是围绕着这三个要素来展开设计。<br/>
我根据发布流程的这三个要素画了一张图。
![](https://static001.geekbang.org/resource/image/c7/d4/c7fb344fb5d8d7ebd57c9e450a1705d4.jpg?wh=4000x2361)
<br/>

- 发布内容，是指搭建平台发布的内容，就是页面的数据和静态资源。这里，静态资源包括页面级的 Bundle 编译文件，以及物料级的各种模块格式 JavaScript 文件和 CSS 文件。
- 流程节点，根据前面企业级最基本流程节点介绍，我们就分成“测试”“预发”和“生产”三个流程节点，来处理页面内容的流转。
- 节点环境，根据流程节点来划分流程环境，可以分成“测试环境”“预发环境”和“生产环境”。然后，基于发布内容的情况，搭建平台发布流程每个环境，需要提供处理页面的“数据”和“静态资源”的内容隔离。
  <br/>

完整发布流程的阶段设计图:
![](https://static001.geekbang.org/resource/image/16/f0/16eff3e523b56f42b6a7ed2e1a9c1ef0.jpeg?wh=4000x2250)
<br/>

我们可以把搭建平台发布流程分成四个执行阶段。<br/>>

- 准备阶段
- 测试阶段
- 预发阶段
- 生产阶段
  <br/>

* 第一阶段，准备阶段，“页面搭建”功能模块完成了“页面布局数据的准备”。这时候是发布流程的前置阶段，还不算真正进入发布流程。
  ![](https://static001.geekbang.org/resource/image/c1/c6/c1097c4d138d318b77b6782834d1a6c6.png?wh=1920x993)
  第二张截图是已经进入发布流程页面，准备下一步流程节点操作。
  ![](https://static001.geekbang.org/resource/image/bf/ac/bfd3b09a7fc3222f3860b832e0f916ac.png?wh=1920x920)

* 第二阶段，测试阶段，正式进入发布流程。<br/>
  在这个阶段中，用户可以操作触发“待发布的内容”流转到测试环境，把准备阶段的数据转到“测试环境”，同时根据测试环境的页面布局数据，编译测试环境的页面 Bundle 文件。
  ![](https://static001.geekbang.org/resource/image/23/e0/2314840c223c18a4d8c1ee1ae99112e0.png?wh=1920x920)
  截图是执行了“发布测试环境”后的状态，可以看出，“内容”发布到测试环境后，进行页面的测试环境编译，生成了测试环境下的多种页面预览格式。程序员可以在测试环境进行功能验证。

* 第三阶段，预发阶段。这个阶段，用户可以操作“发布内容”，从测试环境流转到预发环境。这个操作过程可以是纯数据和资源的复制，复制到预发环境中。
  ![](https://static001.geekbang.org/resource/image/79/76/79f33f71ab32308195ec284ddd0d2b76.png?wh=1920x920)

* 第四阶段，生产阶段，把在预发环境验证好的“发布内容”，流转到生产环境，也就是把页面布局数据和静态资源复制，流转到产线中，让外部用户能访问到页面。<br/>
  同时，我们要记录发布快照，把上产线的数据独立存储，以备有需要的时候有迹可循。
  ![](https://static001.geekbang.org/resource/image/b6/02/b62ec0c3881e1ec938ee5d9a72973e02.png?wh=1920x972)

#### 如何实现多环境的页面验收流程？

综合前面的分析和设计，发布流程都是围绕着“流程节点”和“流程环境”串联流转的。
<br/>
不过，在技术视角上，“流程节点”其实就是“流程环境”，根据不同“节点”的特点，隔离发布的内容。所以，<b>搭建平台发布流程，技术方案的核心，就是对“流程环境”的技术设计。</b><br/>
流程环境是用来处理发布的内容，所以流程环境是没有明确的技术形式，都是随着“发布内容”的类型变化的。 运营搭建平台的发布内容，就是“页面布局数据”和“页面编译 Bundle 文件”。
<br/>
物料的静态资源文件不算在这个发布内容里吗？<br/>
其实可以不算的，因为页面的 Bundle 文件就已经把它编译打包在一起了。如果用 AMD 或者 ESM 模块动态渲染，会根据页面布局数据，选择物料对应版本文件，最后动态渲染页面。
<br/>
所以搭建平台的发布内容，就是“页面布局数据”和“页面 Bundle 文件”，对应的环境技术就是数据库和 CDN。那么实际的技术方案设计，就很清晰了，看设计图。
![](https://static001.geekbang.org/resource/image/ee/89/ee3c91bfdf9d3364642467cf9ac94689.jpg?wh=4000x2250)
<br/>
技术方案，就是基于不同节点环境，把页面数据流转到对应环境的服务器数据库中，把页面静态资源发布到对应环境的 CDN 服务中。
<br/>
意味着需要准备多套数据库服务和 CDN 服务。那样的话，会是一笔记较大的技术花销成本。
<br/>
低成本的多环境方案: 我们可以基于“同一个环境”做数据和静态资源隔离。
![](https://static001.geekbang.org/resource/image/73/e3/73aa17218e66e271c81c1a04f26122e3.jpg?wh=4000x2605)

在低成本方案中，数据的隔离是在同一个数据库中，用多个数据表，隔离同一个数据。同时，在同一个 CDN 或静态资源服务中，用多个目录，隔离同一个文件。
<br/>

> 此文章为 3 月 Day28 学习笔记，内容来源于极客时间《Vue 3 企业级项目实战课》，学习使我快乐，每天进步一点点 💪💪
