### 前台页面版本化管理：如何实现搭建页面的迭代策略？

从客户反馈问题到解决问题，只花了几分钟，一般对客户影响不会太大。但是如果页面被反馈不可用，同时也不能短时间内解决问题，导致客户好几个小时都不能使用，这时候，再好的前台渲染方式也是白搭，毕竟客户是长时间使用不了功能，而不是功能体验不好。
<br/>

在页面进入发布流程后，我们就要做好页面高可用的措施。一般包含监听页面错误、及时反馈报警和页面快速回滚恢复等等。

#### 什么是高可用

高可用，英文是 High Availability，可以简称 HA。在技术领域，通用解释是这样的：
<br/>

> “系统无中断地执行其功能的能力，代表系統的可用性程度。”

<br/>
那搭建平台页面高可用的设计和实现，我们具体如何开展呢？
<br/>
我们基于“页面回滚措施”来实现页面的高可用，页面回滚，就必须要回滚到某次正常发布运行的状态。去哪找页面每次发布的状态呢？这就需要用到页面快照了，也就是每次发布页面后存储在快照中的版本数据。所以，我们面临的第一个问题就是，<b>页面多版本管理</b>要如何设计和实现。

#### 如何设计和实现页面的多版本管理

每次走完发布流程后，我们发布到生产环境的内容，就是搭建出来页面的“页面布局数据”和“页面 Bundle 文件”，其中，Bundle 文件包括 JavaScript 和 CSS 文件。
<br/>
我们在设计运营搭建平台数据库的时候，已经设计了数据库的“页面快照表”。在流程的最后节点，页面发布到生产环境的同时，记录了页面版本数据快照，，存到页面快照表中。<br/>
我们有了版本的数据，剩下的就是版本“Bundle 文件”。
<br/>
其实，我们之前在“页面编译”和“后台发布流程”两节课中，已经把页面按版本增量编译了。页面的 JS 和 CSS 文件在打包之后都带的有版本号。
![](https://static001.geekbang.org/resource/image/a8/91/a806df728847f8c2af9ae20652419591.png?wh=1920x1198)
<br/>
接下来，我们要做的就是进行页面内容管理版本的设计，大致的功能设计效果，你可以参考这张截图。
![](https://static001.geekbang.org/resource/image/be/b0/beafa770edcab2a026449bd65564b8b0.png?wh=1920x1208)

我们把页面版本管理和发布流程聚合在一个页面上，基于快照数据，来管理页面版本数据和版本 Bundle 文件。

<br/>
我们管理页面快照，就等于是管理了页面的版本数据，也间接管理了页面版本的 Bundle 文件。

#### 如何设计和实现回滚措施

要基于多版本的内容来设计和实现回滚措施，首先，我们要理解的一个核心点就是，回滚是把页面恢复到指定版本，其实，就是把对应版本的页面布局数据和 Bundle 文件，重新转入发布流程中。
![](https://static001.geekbang.org/resource/image/de/c6/de6d1fa5133c100730af27e4effba4c6.jpg?wh=4000x2250)
我画了一张具体的流程图，“数据”和“文件”重新投入到发布流程中，再次经过测试、预发和生产三个流程节点，把页面内容恢复到生产环境里。可以分成两步。
<br/>

- 复制内容和提升版本号<br/>
  触发了指定版本的内容的回滚，把指定版本的数据和 Bundle 文件分别复制一份，然后新增一个小版本，进入一次新的发布流程执行操作。<br/>
  ?<br/>
  这是因为在回滚过程中，恢复页面版本操作也是一种发布行为，也需要新增版本号，所以这个时候在复制页面数据过程中，我们也要附加上使用恢复版本号。
  ![](https://static001.geekbang.org/resource/image/1a/6b/1ace71e158206d41dc09a0226bb6946b.png?wh=1920x1208)
- 执行页面发布流程<br/>
  跟原来的发布流程一致，以一个新的页面版本进行发布，并且最后发布到生产环境，也要把这次新版本页面内容再一次备份页面快照。其中，页面快照数据也要携带恢复的版本号信息。

<br/>

很多人会漏掉一个细节问题，回滚版本需要重新进行页面 Bundle 编译吗？<br/>
目前的场景和方案看起来不需要，只需要复制 Bundle 文件就好。但是，注意，如果回滚到某个版本的同时，需要重新编辑页面布局或者物料数据源，就需要重新进行页面的 Bundle 文件编译了。
<br/>

案例：我们就要支持对应的“回滚”加“编辑”的功能，把回滚的操作步骤，从“页面发布流程”提前到“页面搭建”。
<br/>
也就是说，触发了回滚操作后，复制数据和新增版本号，执行的下一个步骤就是“页面搭建”，让用户自己选择是否要重新编辑。在页面布局操作之后，复用“页面搭建”后的发布流程，不管是否重新编辑过页面，都只认传过来的页面布局数据，再编译一次页面 Bundle 文件编译，最后执行发布流程。

<br/>
我们要添加一个环节，在回滚的过程中，支持基于恢复的数据重新编辑。

![](https://static001.geekbang.org/resource/image/13/9c/13aef36bbe8d260be4cf8e222dc62c9c.jpg?wh=4000x2250)
<br/>
看修改后的步骤图，回滚和重新页面搭建编辑的步骤分成三步。<br/>

- 第一步：复制内容和更新版本号
- 第二步：重新进行页面搭建的编辑
- 第三步：复用执行页面发布流程

#### 还有哪些前置型高可用的措施

前置型的高可用措施，我们可以两个视角思考。
<br/>

- 避免项目出现问题<br/>
  避免出现问题，就是尽量不要让问题出现，这就要在搭建页面的每个环节，做好严格把关。例如，物料组件开发代码质量、页面搭建拼接代码质量的严格审查等等，更多是<b>在进入发布流程的前置阶段，做好质量把关</b>。
- 避免项目问题扩大化<br/>
  保证在出问题的苗头时，第一时间扑灭，减少问题影响面和影响时间。

<br/>
我们无法保证我们的代码是十全十美的，有些问题，需要特定的时间、特定的场景出现，所以我们需要尽量第一时间发现问题和解决问题，这个角度我们需要做的措施一般都是进行页面监控。这里的“监控”指的是定时收集产线页面的报错信息，上报到服务器形成日志，并且，自动归类报错日志，某类日志报错超过一定警戒线时候，就触发警报，通过短信、邮件、甚至是机器人语音电话通知。

<br/>

> 此文章为 3 月 Day29 学习笔记，内容来源于极客时间《Vue 3 企业级项目实战课》，学习使我快乐，每天进步一点点 💪💪
