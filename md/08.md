### 如何从零搭建自研的 Vue 组件库？

#### 自研开发 Vue.js 3.x 组件库能带来什么？

- 一方面是定制化的需要。
- 另一方面，也能锻炼和提高自己的技术能力，提升工作效率。

#### Vue.js 3.x 组件库开发要点

Vue.js 3.x 组件库的核心作用是可以给其它项目复用。<br/>

我们就需要考虑将组件库里的 Vue.js 代码编译成 JavaScript 文件，保证能支持引入组件库 npm 模块的同时，还要能自动识别 TypeScript 类型、支持 ES Module 和 CommonJS 模块格式、组件按需加载等操作。
<br/>

总体来讲，这里可以划分为三个技术要点：

1. monorepo 管理组件代码；
2. Vue.js 3.x 源文件的多种模块格式编译；
3. 基于 Less 开发 CSS 样式文件和独立编译。

<b>先看第一点，monorepo 管理组件库代码。</b>
根据业务需要，组件库划分为多个 npm 模块管理，同时尽量在同一个代码仓库进行维护，因为不同组件之间可能存在依赖关系。要保证能在一个代码仓库中快速调试多个 npm 模块的代码效果。一个仓库管理多个 npm 模块（多个子项目），就需要用到 monorepo 的项目管理形式。<br/>

<b>第二个要点，了解 Vue.js 3.x 源文件的多种模块格式编译。</b>
开发者在使用组件库的时候，可以有多种 JavaScript 模块的使用格式，常见的是 ES Module 和 CommonJS 模块格式，所以我们也要将源码编译成 ES Module 和 CommonJS 格式。<br/>
需要支持按需加载<br/>
保证代码质量，采用 Typescript 开发，在打包编译输出 Javascript 的 npm 模块里，加上编译输出组件库的 JavaScript 的 TypeScript 类型描述文件 （\*.d.ts 文件）。<br/>

<b>第三点，基于 Less 开发 CSS 样式文件和独立编译。</b>
定制化需求，特别是前端页面的主题定制化能力，甚至是同一个企业内不同业务项目的主题定制都不一样。
考虑到要支持主题配置，我们采用 Less 来进行“编程方式”开发 CSS。动态编译采用 Less 这个 CSS 的“预处理语言”。

#### 如何搭建 monorepo 项目？

我们可以参考 Vue.js 官方在 GitHub 上的代码仓库 https://github.com/vuejs/core 的 monorepo 方案选择，就是用 pnpm 来管理 monorepo 项目，主要利用 pnpm 天然支持 monorepo 的管理能力，同时 pnpm 安装 node_modules 也能更省体积空间。<br/>

具体操作：

- 初始化代码目录；
- 基于 pnpm 配置 monorepo 项目；
- 安装所有子项目依赖。

先看第一步，初始化项目的代码目录，项目的代码基础目录如下所示：

```
.
├── package.json
├── packages/               # 多子项目的目录
│   ├── business/           # 业务组件库 - 子项目目录
│   │   ├── package.json    # 业务组件库 - 子项目package.json声明
│   │   └── src/*           # 业务组件库 - 子项目源码目录
│   └── components/         # 基础组件库 - 子项目目录
│       ├── package.json    # 基础组件库 - 子项目package.json声明
│       └── src/*           # 基础组件库 - 子项目源码目录
├── pnpm-workspace.yaml
├── scripts/*
└── tsconfig.json
```

第一步完成，我们进行第二步，基于 pnpm 配置 monorepo 项目。
![](https://static001.geekbang.org/resource/image/ab/26/ab87e909fcf7083848ec07be9debac26.png?wh=1920x1007)

#### 怎么对组件库做编译设置？

实现了多种类型组件库项目聚合的 monorepo 项目目录，我们就要开始准备各个子项目的初始化源码和源码的编译脚本。<br/>

我们可以这样设计子项目里组件库的文件目录格式：

```

.
├── README.md
├── env.d.ts
├── package.json
├── packages
│   ├── business/
│   │   ├── package.json
│   │   └── src/                    # 业务组件库 - 子项目源码目录
│   │       ├── comp-000/           # 业务组件 - 单独组件目录
│   │       │   ├── xxxx.vue
│   │       │   ├── index.ts        # 业务组件 - 组件索引文件
│   │       │   └── style
│   │       │       └── index.less  # 业务组件 - 组件样式文件
│   │       ├── comp-001/*
│   │       ├── comp-002/*
│   │       ├── index.less
│   │       └── index.ts
│   └── components/
│       ├── package.json
│       └── src                     # 基础组件库 - 子项目源码目录
│           ├── comp-000/           # 基础组件 - 单独组件目录
│           │   ├── xxxx.vue
│           │   ├── index.ts        # 基础组件 - 组件索引文件
│           │   └── style
│           │       └── index.less  # 基础组件 - 组件样式文件
│           ├── comp-001/*
│           ├── comp-002/*
│           ├── index.less
│           └── index.ts
├── pnpm-workspace.yaml
├── scripts/*
└── tsconfig.json
```

既然我们统一了组件的目录格式，那么接下来我们就要根据不同类型的对应组件目录，进行代码的编译。代码编译分成以下三个步骤：<br/>

- 第一步：编译 TypeScript 和 Vue.js 3.x 源码为 ES Module 和 CommonJS 模块的两种 JavaScript 代码文件；
  编译 TypeScript 和 Vue.js 3.x 源码成 ES Module 和 CommonJS 模块的两种 JavaScript 代码文件。
  脚本文件是 scripts/build-module.ts
- 第二步：编译出所有 JavaScript 文件的 TypeScript 类型描述文件；
  编译出所有 JavaScript 文件的 TypeScript 类型描述文件。这就需要在项目的 scripts/\* 目录下编写以下编译脚本。
  脚本文件是 scripts/build-dts.ts
- 把文件编译 Less 成 CSS 文件。
  第三步，也就是最后一步，我们要来把 Less 文件编译成 CSS 文件。我们需要在项目的 scripts/\* 目录下编写以下编译脚本。
  脚本文件是 scripts/build-css.ts

#### 在其他项目中使用组件库

组件库开发要点，其中一个是可以支持组件的<b>按需加载</b>，也就是其他项目使用组件库的时候，可以按照自己需要使用个别组件，而不会把整个组件库全量打包。

所以在组件库发布到 npm 企业内部站点的时候，我们还需要在组件库子项目每个 package.json 文件里加上以下配置：

```

{
  "main": "dist/cjs/index.cjs",
  "module": "dist/esm/index.mjs",
  "types": "dist/esm/index.d.ts",
  "exports": {
    ".": {
      "require": "./dist/cjs/index.cjs",
      "import": "./dist/esm/index.mjs",
      "types": "./dist/esm/index.d.ts"
    },
    "./esm/*": {
      "import": "./dist/esm/*/index.mjs",
      "types": "./dist/esm/*/index.d.ts"
    },
    "./cjs/*": {
      "require": "./dist/cjs/*/index.cjs",
      "types": "./dist/cjs/*/index.d.ts"
    },
    "./css/*": "./dist/css/*"
  }
}
```

以上配置就是可以让使用者在使用组件库的时候，可以全量使用，例如 ES Module 格式使用：<br/>

```
import { Comp001, Comp002 } from '@my/components'
import '@my/components/css/index.css'
```

换成 CommonJS 格式使用：<br/>

```
const { Comp001, Comp002 } = require('@my/components');
require('@my/components/css/index.css')
```

也可以按需使用组件库，避免出现构建器对代码全量打包，例如 ES Module 格式使用：

```
import Comp001 from '@my/components/esm/comp-001';
import Comp002 from '@my/components/esm/comp-002';
import '@my/components/css/comp-001/style/index.css';
import '@my/components/css/comp-002/style/index.css'
```

换成 CommonJS 格式使用：

```
const Comp001 = require('@my/components/cjs/comp-001');
const Comp002 = require('@my/components/cjs/comp-002');
require('@my/components/css/comp-001/style/index.css');
require('@my/components/css/comp-002/style/index.css');
```

> 此文章为 3 月 Day9 学习笔记，内容来源于极客时间《Vue 3 企业级项目实战课》，学习使我快乐，每天进步一点点 💪💪
