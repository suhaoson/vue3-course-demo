### 受控表单组件：如何开发受控的表单组件？

#### 什么是受控组件和非受控组件？

- 受控组件，按照 React 官网的描述，就是用 React.js 内部 state 来管理 HTML 表单的数据状态，同时也控制用户操作表单时的数据输入。这类被 React.js 以这种方式控制取值的表单输入元素就叫做“受控组件”。
- 非受控组件，React 官网的描述是这样的，“在大多数情况下，我们推荐使用受控组件来处理表单数据。在一个受控组件中，表单数据是由 React 组件来管理的。另一种替代方案是使用非受控组件，这时表单数据将交由 DOM 节点来处理”。

简单来讲，<b>“受控组件”就是通过内置统一状态或者数据管理来控制表单操作，而“非受控组件”就是使用原生 HTML 的表单特性来实现表操作。</b>

今天讲的主要是表单场景，所以统一语义，避免产生歧义，我们对“受控组件”和“非受控组件”统一称为“受控表单组件”和“非受控表单组件”。<br/>

#### 受控表单组件和非受控表单组件各有什么优劣？

“非受控表单组件”和“受控表单组件”这两种表单组件的 Vue.js 3.x 代码实现方式，我们简单对比一下代码实现的复杂度和代码量：
![](https://static001.geekbang.org/resource/image/05/8e/05cc464938c659822e30b920f5c0568e.jpg?wh=5000x1556)

如果我们在 Vue.js 3.x 环境里，再加上“数据监听”和“数据校验”这两个功能维度，会是怎样呢？
![](https://static001.geekbang.org/resource/image/98/93/98f2d8e0d47d072f2916e9425fab7b93.jpg?wh=5000x1862)

实现同样的注册表单的功能代码，受控表单组件的实现方式，明显比非受控表单组件更简单，而且更加方便数据字段的扩展。所以一般在开发组件库里的表单组件时，我们都基于“受控组件”的技术理念来开发“受控表单组件”。<br/>

但是，开发组件库的表单组件，使用“受控组件”的概念是远远不够的，组件库，一个很重要的优势是复用性，实际工作开发需求时，表单的功能需求是多种多样的。<br/>

怎么做？ 抽象表单通用逻辑，封装成统一受控的表单组件。
<br/>

#### 怎么封装 Vue.js3.x 的受控表单组件？

首先，我们要明白，传统表单是由一个个数据字段组成的，承载这些数据的显示和输入的是 HTML 里的 &lt;input&gt;、&lt;select&gt; 和 &lt;option&gt; 等元素。
<br/>

统一称呼，例如“表单数据组件”“数据输入组件”“数据录入组件”，为了避免歧义，表单里类似 &lt;input&gt;、&lt;select&gt; 等承载表单数据功能的组件，我们就统一称为“表单数据组件”。同时，承载表单提交的能力的组件，比如 HTML 里 &lt;form&gt; 标签类似功能组件，我们就称为“表单组件”。
<br/>

- 第一步，梳理出表单操作中可复用的逻辑。表单操作可以复用的逻辑是什么呢？
  - 数据字段名称
  - 数据校验
- 第二步，把可以复用的逻辑功能封装成通用表单逻辑功能组件。
  “数据字段名称”和“数据校验”操作，都是跟着作用于每个表单里的“数据字段”的。通常在英文语境里，我们称呼这个表单的数据字段为“Field”，在此我们就统一用中文描述为“表单字段”。
- 第三步，也就是实现代码的阶段。我们先画图设计一下实现流程，“表单字段组件”其实就是“表单数据组件”和“表单组件”之间的“桥梁”：

![](https://static001.geekbang.org/resource/image/ca/cb/cac23960d1a5190aeaef566381aeabcb.jpg?wh=6000x3543)

那我们再进一步细化“表单字段组件”发挥的具体的桥梁作用：
![](https://static001.geekbang.org/resource/image/8c/2a/8c39bec076060639e1ff4a269a6cd52a.jpg?wh=6000x3151)

表单字段组件，给表单数据组件传递“字段名称”和“字段校验规则”，给表单组件也是传递“字段名称”和“字段校验规则”
<br>
通过两张图，我们可以总结出一个实现代码的要素，需要一个“上下文”来给整个表单共享“字段名称”和“字段校验规则”的内容，而“表单字段组件”只是作为一个入口，在使用时帮忙把“字段名称”和“字段校验规则”注册到这个共享内容的“上下文”里。

#### Vue.js 3.x 里实现跨组件的数据共享，有哪些方式呢？

Vue.js 3.x 的新特性， provide 和 inject<br/>

我们可以在父级组件用 provide 定义一个“共享数据”及其名称，在子组件里用 inject，通过这个数据名称拿到这个父级组件的“共享数据”。如果这个“共享数据”是“响应式数据”类型，我们在子组件里修改这个“共享数据”就可以触发响应式特性，影响到父组件和其他子组件的操作。反之，如果“共享数据”是“普通变量数据”，子组件里是无法修改影响父组件的。

#### 如何给封装的受控表单组件做统一提交校验？

在 HTML 里，原生的表单标签 &lt;form&gt; 是支持统一的 submit 事件的。我们现在要做的是，拦截这个表单事件，在提交数据前，从“共享数据”里拿到校验规则和所有数据来做数据校验，校验不通过就阻断表单提交。
<br/>

> 此文章为 3 月 Day13 学习笔记，内容来源于极客时间《Vue 3 企业级项目实战课》，学习使我快乐，每天进步一点点 💪💪
