### 前台页面的性能优化：如何实现前台页面的性能优化？

在运营搭建平台中，从页面功能维度，我们划分了五个功能模块，分别是页面搭建、页面编译和运行、页面发布流程、页面版本管理和页面渲染方式，在前五节课，我们实现了用户、物料和页面这三大功能维度，等于完成了搭建平台的核心功能。
<br/>
进入平台优化和扩展的设计开发阶段，会分成两个层次展开：实战类、增强类。
<br/>
<b>实战类</b>：平台优化
<br/>

#### 1. 什么时候需要做性能优化

在开发周期中，其实这没有标准答案，但是有参考思路，我总结了两种思路。<br/>

- 前置优化思路
- 后置优化思路

##### 前置优化思路

<br/>
所谓的前置优化，就是在项目投入开发前，进行性能优化设计，也就是项目做技术方案设计的阶段，优先考虑优化设计。
<br/>

<br/>
前置优化的思路，优点就是前期做了大量优化工作，避免后期出现高概率性能问题。但缺点就是<b>加大了整体开发时间，不适合迭代频率高的业务，甚至容易陷入“过度优化”的困境。</b>
<br/>
举个例子：比如在搭建平台项目中，前端程序员评估预测一些极端边缘情况，可能会出现搭建页面依赖了几十个甚至上百个物料组件，导致编译 Bundle 文件过大，加载时间过长。但实际场景可能并不常见这种极端情况。
<br/>

##### 后置优化思路

所谓“后置”优化，就是优先实现业务需求功能，后续看情况做性能优化。
<br/>
后置优化的优点很明显，让实际开发时间可控，也不会出现“过度设计”的问题。当然缺点也显而易见，<b>优先设计和开发业务需求功能，缺乏整体的性能优化设计</b>，如果后续每次遇到性能问题，就只能“头疼医头，脚疼医脚”，容易引入大量冗余逻辑和代码。
<br/>

##### 两种思路分析

总的来说，这两种思路，你可以根据实际的项目情况选择。但是，不能墨守成规套用思路，应该尽量基于思路的优缺点，扬长避短，调整使用。
<br/>
一般企业内的前端工作，大量是业务功能开发，这时候可以尽量选择“后置优化”的思路做功能开发，不过你要做相关的思路微调。
<br/>
例如在开发的时候，尽量设想一下可能出现的性能问题，然后做好预留优化操作的逻辑，不一定要做完整的优化设计，但是可以预留一些可操作的空间。

#### 2. 如何发现和分析性能问题

客户或者用户在使用前端页面的时候，碰到了性能问题，通常是不可能用技术层面的术语来反馈的，而是会直接描述遇到的现象，比如，“页面太卡了”“图片破了”等等。
<br/>

开发者排查技术问题。还原问题场景，然后根据问题现象，发现和分析技术层面的问题点。<br/>

常见的场景：<br/>

- 打开页面卡顿
- 操作功能卡顿
- 图片等很久才显示
- 图片太多不显示
  <br/>

排查问题工具：Chrome 的 DevTools<br/>
第一步，可以先从网络情况开始排查，切换到 DevTools 的网络面板“Network”，查看打开页面时候的网络请求情况。
![](https://static001.geekbang.org/resource/image/db/8f/db09e90aef005d11843cf6e6abdf308f.png?wh=1920x807)

从截图中可以看到，Chrome 浏览器的开发者控制台中，红框展示的页面的网络请求情况。
<br/>
如果请求数量很大或文件体积很大，同时，请求等待时间很长，“页面打开卡顿”问题在技术层面的原因，可以从“页面网络请求”耗时排查起来。
<br/>

如果页面网络情况都在正常范围内，我们就需要进入第二步排查。
<br/>
第二步，查看 Chrome 浏览器里控制台的性能情况。这时候你需要把 DevTools 切换到性能面板“Performance”，然后进行性能录制，重新加载页面，最后停止录制显示性能分析结果。
<br/>

![](https://static001.geekbang.org/resource/image/7c/82/7c6240a80e03300c6ebb6cbb391cf782.png?wh=1920x1351)

![](https://static001.geekbang.org/resource/image/a9/14/a90d3cb5f4ee594e78e5c4f7da186d14.png?wh=1920x1351)
从截图中可以看出每一帧渲染的性能情况，同时，你可以看到每段 JavaScript 代码执行时的性能情况。这里的性能情况包括 CPU、内存的占用，以及代码执行时间。
<br/>
通过性能面板来分析，可以看到那一个渲染阶段或是哪一段代码，影响了性能。
<br/>
第三步，如果觉得性能分析没问题，要看最后一个技术维度——帧率。<br/>

> “帧率，Frame Rate，是用于测量显示帧数的度量。测量单位为“每秒显示帧数”，英文称为 Frame Per Second，简称 FPS，一般来说 FPS 用于描述影片、电子绘图或游戏每秒播放多少帧。”

_浏览器显示的页面变化，是一帧帧的静态画面，按时间顺序组合而成的，如果每秒“闪过”画面的帧数接近 60 帧，属于很流畅的页面渲染，如果远远少于 60 帧，例如 30FPS，就已经是卡顿的页面渲染了。_
<br/>

在控制台输入命令 fps，你就可以调用帧率的显示工具。
![](https://static001.geekbang.org/resource/image/6e/cd/6efecec9a4df95bfbaa6ac7340e573cd.png?wh=1920x1143)
打开了 FPS 工具，就可以在页面上看到实时的帧率情况。
![](https://static001.geekbang.org/resource/image/91/71/918aa45a8001477b035ccb4451876171.png?wh=1920x934)
这个帧率要结合性能面板里的信息内容综合判断，比如要结合每帧渲染情况、对应时间轴的 JavaScript 执行内容、内存情况和 CPU 情况等等。
<br/>

一般出现帧率的页面卡顿问题，很大可能是这四种情况。<br/>

- 页面里 HTML 渲染结构过于复杂。
- 页面运行的 JavaScript 可能有死循环代码。
- setInterval 或 requestAnimationFrame 的不规范使用。
- 页面有用 Canvas 渲染 2D 或 3D 的内容，且内容过于复杂。

#### 3. 如何对症下药做前端性能优化

分析了性能问题的技术原因后，你会发现一般与性能相关的技术原因，基本是围绕着网络、CPU、内存和帧率这四个技术角度展开的。
<br/>

- 网络问题：请求量多，文件体积太大。
- CPU 问题：执行复杂计算的 JavaScript 操作。
- 内存问题：代码逻辑原因，加载资源过大原因。
- 帧率问题：渲染内容复杂度原因，例如 HTML 结构、Canvas 的 2D 和 3D 渲染的内容复杂度。

<br/>

一般归纳为三种技术问题：<br/>

- 第一类，网络并发或静态资源过大。
- 第二类，渲染内容过于复杂。
- 第三类，代码逻辑不规范。

第一、二类技术问题，我们可以统一处理，<b>按需延迟加载或渲染内容</b>
![](https://static001.geekbang.org/resource/image/79/5d/79200e9b335a1cb06b5167f3be445a5d.jpg?wh=4000x2678)
<br/>
懒加载优化可以这么来设计实现。
![](https://static001.geekbang.org/resource/image/61/a2/61f464ef708673a6344ebf1f759cf4a2.jpg?wh=4000x2678)

#### 4. Vue.js 项目如何进行优雅的性能优化

从 Vue.js 图片懒加载的代码案例来看，我们的代码实现方式是基于一个 Vue.js 插件，再结合少量的图片自定义指令代码的修改。那么归纳一下，Vue.js 项目性能优化的优雅实现思路，主要有两个要点。
<br/>

- 要点一：优化逻辑尽量独立插件化。
  - 尽量实现独立插件化
- 要点二：尽可能少修改存量代码。
- 如果插件逻辑不能覆盖全部优化操作，需要修改一些存量代码。就尽量控制存量代码的改动量，改动越少，新引进的问题就越少。

<br/>

> 此文章为 3 月 Day31 学习笔记，内容来源于极客时间《Vue 3 企业级项目实战课》，学习使我快乐，每天进步一点点 💪💪
