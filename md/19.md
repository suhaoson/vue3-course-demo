### 全栈项目搭建：如何搭建 Vue.js 的前后台全栈项目？

前面课程已经实现 Web 服务开发、Node.js 服务端分层、Vue.js 前端渲染和服务端渲染，广义上已经算是全栈项目了；但是从实际项目角度分析，还不满足课程中运营搭建平台的“全栈”功能需要。

#### 全栈系统设计需要准备什么？

我们最终的项目是实现一个运营搭建平台，需要考虑项目的用户人群。
<br/>
那就要考虑两个用户维度：员工、客户。在大厂的项目中，这类场景需要把平台拆分成两个独立的服务。拆分主要从<br/>“安全”、“稳定”和“便于维护”<br/>三个因素考虑的。
<br/>

- 安全，指的是平台功能、数据等安全因素。
  <br/>
- 稳定，指的是功能使用的稳定。
  <br/>
- 便于维护，指的是便于后续升级或者改造。
  <br/>

既然要前台后台服务分离，如何设计呢？我整理了三步。<br/>

- 第一步：Web 服务的拆分和隔离<br/>
  第一步，Web 服务的拆分和隔离。如果业务体量不大的话，前台和后台两个 Web 服务可以独立部署，在同一台服务器上，各自使用独立的服务端口。同时，还需要使用类似 Nginx 的网关服务，进行同一机器上不同端口服务的域名端口转发管理。
  ![](https://static001.geekbang.org/resource/image/ae/d2/ae13cb17f32292827e0e949d3d2f0bd2.jpg?wh=1920x1188)
  <br/>
  如果业务体量变大了，例如搭建的页面访问用户量增大，服务器压力扛不住了，可以把面向用户的前台 Web 服务独立出来，用集群来部署，以应付前台大量的用户请求。
  ![](https://static001.geekbang.org/resource/image/f5/36/f5ecb2aec7f4805f250fe978c1ffbe36.jpg?wh=1920x1188)
- 第二步：前台和后台 Web 服务的系统设计<br/>
  - 后台服务，面向企业内部员工，服务核心是提供搭建页面能力，那么最重要的就是员工操作权限控制，页面搭建和发布的流程管理。
  - 前台服务，面向外部客户，服务核心是提供能力渲染“已搭建好”的页面。这里的渲染能力需要支持 SSR，也就是服务端渲染，能支持 SEO，也就是浏览器引擎优化。
- 第三步：前后台的数据和资源的共享设计<br/>
  ![](https://static001.geekbang.org/resource/image/9d/94/9dd24441fc1f415eea3d6514c110de94.jpg?wh=1920x1188)
  我们可以看到系统分层，最底层是操作共享的数据和资源。
  <br/>
  共享的资源主要是页面静态资源，一般存储在 CDN 服务器上。
  对于共享数据的操作，就需要用到数据库。

#### 如何准备数据库服务环境？

首先，我们要选择数据库。数据库选择很多，MySQL、MongoDB 等等。那要怎么选呢？<br/>
我们会用 MySQL 这一关系型数据库来作为项目数据库，主要是考虑“关系型数据库”和“国内企业使用情况”这两个因素。
<br/>

- 第一个因素，MySQL 是关系型数据库，而且是被很多企业广泛使用的数据库。
- 另一个因素“国内企业使用情况”。国内大部分企业，基本都是用 MySQL 或者“类 MySQL”的数据进行系统开发。
  <br/>

具体安装步骤：

1. 首先从官网下载 MySQL 的社区版服务安装包（ https://dev.mysql.com/downloads/mysql/），安装成功后，用 root 账号登录一下，看看是否能访问默认的数据库内容：
   ![](https://static001.geekbang.org/resource/image/ae/31/ae10a0d1acd2b3fd018c285381930531.png?wh=992x494)
2. 接下来，我们就用 Node.js 来操作数据库，这里要注意，刚刚我们安装的是 MySQL 的“服务端”，现在需要用“客户端”来进行服务端操作。<br/>
   先演示一下数据库“建库”的操作代码。

```
/* eslint-disable no-console */
import mysql from 'mysql';

// 需要创建的数据库名称
const database = 'hello_vue_project';
// 数据库连接配置
const config = {
  host: '127.0.0.1',
  port: 3306,
  user: 'root',
  password: 'xxxxx' // 这里需要填写自己电脑本地MySQL数据库的密码
};

// 创建一个数据库连接池
// 用来建库
const pool = mysql.createPool(config);

// 封装连接池执行方法
function querySQLByPool(sql: string) {
  return new Promise((resolve, reject) => {
    pool.query(sql, (err, results, fields) => {
      if (err) {
        pool.end();
        reject(err);
      } else {
        pool.end();
        resolve({ results, fields });
      }
    });
  });
}

async function init() {
  // 建库 SQL 语句
  const sqlDB = `CREATE DATABASE IF NOT EXISTS ${database};`;
  // 执行建库操作
  await querySQLByPool(sqlDB);
  console.log(`运营搭建平台 - 数据库 ${database} 建库成功！`);
}

// 开始数据库初始化
init();
```

上述代码中，我在 Node.js 环境里，用 SQL 语法实现了一个数据库“hello*vue_project”的创建，代码里面的账号密码都是本地 MySQL 数据库的。<br/>
*如果你使用最新版 MySQL 操作数据库，遇到如下报错。\_

```
Error: ER_NOT_SUPPORTED_AUTH_MODE: Client does not support authentication protocol requested by server; consider upgrading MySQL client
```

![](https://static001.geekbang.org/resource/image/46/be/46dbe69366c19d10d4ff5f8db1468fbe.png?wh=948x344)
这个问题是由于 MySQL 最新版本的加密方式和 Node.js 的 mysql 客户端不一致产生的，通过以下 MySQL 脚本，在 MySQL 命令框里修改就能解决问题。<br/>

```
# 更新root账号密码，用其他加密形式处理
# 里面的'password'为实际的密码
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'password';

# 刷新配置
FLUSH PRIVILEGES;
```

3. 接下来就进入数据库建表，我来演示一下数据库的“建表”操作代码。用 SQL 语法，在数据库“hello_vue_project”，实现了一个表"user_info"的创建，用来存储用户数据信息。

```

/* eslint-disable no-console */
import mysql from 'mysql';

// 需要创建的数据库名称
const database = 'hello_vue_project';
// 数据库连接配置
const config = {
  host: '127.0.0.1',
  port: 3306,
  user: 'root',
  password: '1234abcd'
};

// 创建一个数据库连接池
// 用来建表
const poolDatabase = mysql.createPool({ ...config, ...{ database } });

// 封装连接池执行方法
function queryDatabaseSQLByPool(sql: string) {
  return new Promise((resolve, reject) => {
    poolDatabase.query(sql, (err, results, fields) => {
      if (err) {
        poolDatabase.end();
        reject(err);
      } else {
        poolDatabase.end();
        resolve({ results, fields });
      }
    });
  });
}

async function init() {
  // 建库 SQL 语句
  const sqlDB = `
  CREATE TABLE  IF NOT EXISTS \`user_info\` (
    \`id\` int(11) NOT NULL AUTO_INCREMENT,
    \`uuid\` varchar(128) NOT NULL UNIQUE COMMENT '员工用户UUID',
    \`username\` varchar(64) NOT NULL UNIQUE COMMENT '员工用户名称',
    \`password\` varchar(64) NOT NULL COMMENT '员工用户密码',
    \`info\` json COMMENT '扩展描述（JSON数据格式）',
    \`create_time\` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    \`modify_time\` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后修改时间',
    PRIMARY KEY (\`id\`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
  `;
  // 执行建表操作
  await queryDatabaseSQLByPool(sqlDB);
  console.log('运营搭建平台 - 数据表 user_info 创建成功！');
}

// 开始数据库初始化
init();

```

4. 查询操作
   再接着，用 Node.js 在表里查询数据的操作，代码如下所示。
   code...
   这里，我演示一下在表里查询数据的操作。
   code...
5. 最后演示一下表的更新数据操作。
6. MySQL 本身有提供删除数据的操作，但是实际项目中，我们不会真的删除数据，只会用“假删除”的方式进行删除数据，例如给表加个字段标注是否删除。这样做，是为了避免误删数据导致故障或者损失。

#### 如何搭建全栈项目的数据库配置？

数据库的配置首先要区分环境，比如本地开发环境、测试环境和生产环境，你可以通过 Node.js 进程的环境变量进行控制。我推荐用 dotenv 这个 npm 模块，用来基于环境变量管理 MySQL 的配置，看看如何操作。
<br/>

- 先在项目的根目录建一个 “.env”文件，并且将环境变量配置到该文件里。

```
# .env 文件
MYSQL_HOST = "127.0.0.1"

MYSQL_PORT = "3306"

MYSQL_DATABASE = "my_vue_project_20"

MYSQL_USER = "root"

MYSQL_PASSWORD = "xxxx"
```

- 在项目服务端代码中，可以这么来使用环境变量。

```

import mysql from 'mysql';
import dotenv from 'dotenv';

dotenv.config();

// 需要创建的数据库名称
const database = process.env.MYSQL_DATABASE;
// 数据库连接配置
const config = {
  host: process.env.MYSQL_HOST,
  port: parseInt(process.env.MYSQL_PORT),
  user: process.env.MYSQL_USER,
  password: process.env.MYSQL_PASSWORD
};

const pool = mysql.createPool(config);

```

- 如果在开发过程中，出现 TypeScript 类型声明报错，可以重新定义环境变量的类型声明。

**如果你在企业有用 Docker，或者购买其它云服务厂商的 MySQL 服务，可以把数据库的账号密码设置在 Docker 等容器的环境变量里。**<br>
**生产环境中数据库的账号不能用 root 权限的账号，容易带来权限安全问题，最好用 MySQL 创建一个只有某个数据库的“增改查数据”权限的账号。**

> 此文章为 3 月 Day20 学习笔记，内容来源于极客时间《Vue 3 企业级项目实战课》，学习使我快乐，每天进步一点点 💪💪
