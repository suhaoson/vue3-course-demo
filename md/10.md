### 动态渲染组件：如何实现 Vue 的动态渲染组件？

#### 什么是动态渲染组件？

一般被称为“反馈类型组件”。如果从技术实现方式上归类，就可以归纳为“动态渲染组件”。例如：对话框、消息提醒和侧边抽屉等组件，来做一些信息的动态显示和动态操作。<br/>

从技术实现的角度，动态渲染组件就是通过“动态”的方式来“渲染”组件，不需要像常规 Vue.js 3.x 组件那样，把组件注册到模板里使用。<br/>
动态渲染组件的两个技术特点就是：<br/>

- 以直接函数式地使用来执行渲染，使用者不需要写代码来挂载组件；
- 组件内部实现了动态挂载和卸载节点的操作。

<b>Vue.js 3.x 动态渲染组件在页面上是独立于“Vue.js 主应用”之外的渲染。</b>
因为，动态渲染组件，在项目应用里，只是调用组件的函数（或者方法），然后创建一个独立于“Vue.js 主应用”外的一个“Vue.js 副应用”，动态挂载（mount）在 HTML 动态创建的 DOM 上。如果要关闭动态渲染组件，就需要再次触发一个关闭函数（或者方法），把这个“Vue.js 的副应用”卸载（unmount），最后把动态创建的 DOM 也一并销毁回收。这样，就完成动态渲染组件从挂载到卸载的一个完整的生命周期。
<br/>

工作中高频使用：消息提醒组件（Message）和对话框组件 (Dialog)。围绕这两个组件展开：

#### 实现动态渲染组件需要做什么技术准备？

组件库是提供给开发者使用的，除了功能，开发者最关心的当然就是组件的 API（接口）使用方式，所以动态渲染组件 API 设计尤为重要。
<br/>
<b>使用步骤尽量少，使用代码尽量精简</b>
<br/>
而动态渲染组件整个生命周期，最核心的就是“动态挂载”和“动态卸载”两个步骤，所以 API 的设计，可以直接围绕着“挂载”和“卸载”两个来设计，最简单的可以设计成如下代码：
<br/>

```
import { Module } from 'xxxx'

// 动态组件挂载
Module.open({  /* 组件参数 */ });

// 动态组件卸载
Module.close();
```

如果考虑到组件不是单例的，而是多实例共存的，可以这么设计 API：<br/>

```
import { Module } from 'xxxx'

// 创建动态组件 mod1
const mod1 = Module.create({  /* 组件参数 */ });
// 挂载渲染 mod1
mod1.open();
// 卸载动态组件 mod1
mod1.close();



// 创建动态组件 mod2
const mod2 = Module.create({  /* 组件参数 */ });
// 挂载渲染 mod2
mod2.open();
// 卸载动态组件 mod2
mod2.close();
```

如果动态组件在其生命周期还需要添加一些节点，可以这么来设计：<br/>

```
import { Module } from 'xxxx'

// 创建动态组件 mod1
const mod1 = Module.create({  /* 组件参数 */ });
// 挂载渲染 mod1
mod1.open();
// 更新组 mod1 件内容
mod1.update({ /* 更新内容参数 */ })
// 卸载动态组件 mod1
mod1.close();
```

完成了动态组件的函数方法 API 设计，接下来，我们学习 Vue.js 3.x 实现组件的动态挂载和卸载操作。

```
import { defineComponent, createApp, h } from 'vue';

// 用 JSX 语法实现一个Vue.js 3.x的组件
const ModuleComponent = defineComponent({
  setup(props, context) {
    return () => {
      return (
        <div>这是一个动态渲染的组件</div>
      );
    };
  }
});

// 实现动态渲染组件的过程

export const createModule = () => {
  // 创建动态节点DOM
  const dom = document.createElement('div');
  // 把 DOM 追加到页面 body标签里
  const body = document.querySelector('body') as HTMLBodyElement;
  const app = createApp({
    render() {
      return h(DialogComponent, {});
    }
  });


  // 返回当前组件的操作实例
  // 其中封装了挂载和卸载组件的方法
  return {
    open(): () => {
      // 把组件 ModuleComponent 作为一个独立应用挂载在 DOM 节点上
      app.mount(dom);
    },
    close: () => {
      // 卸载组件
      app.unmount();
      // 销毁动态节点
      dom.remove();
    }
  }
}
```

上面封装的一个最简单的动态渲染组件，可以这么使用：

```
import { createModule } from './xxxx';

// 创建和渲染组件
const mod = createModule();

// 挂载渲染组件
mod.open();

// 卸载关闭组件
mod.close();
```

#### 如何实现一个动态 Message 组件？

效果：<br/>
![](https://static001.geekbang.org/resource/image/a3/c8/a38e2f1a60daa1c57be8101dd393f4c8.gif?wh=599x316)
实现这个 Message 动态渲染组件，主要分四步：<br/>

- 第一步，先用 Vue.js 3.x 模板语法实现 Message 的模板组件；
- 第二步，封装 open 函数来控制挂载渲染这个模板语法的 Message 组件；
- 第三步，封装 close 函数来控制卸载关闭这个组件；
- 第四步，扩展 open 函数，内置一个定时器来控制延时自动关闭组件。

#### 动态渲染组件的动画效果实现？

效果：<br/>
![](https://static001.geekbang.org/resource/image/26/9e/263e3d6d1ed11ab7668c54bd2bcb779e.gif?wh=599x316)
基于上述的 Message 组件，我们可以加入 &lt;transition&gt; 内置组件来控制动画过渡。

#### 如何实现一个动态 Dialog 组件？

效果：
![](https://static001.geekbang.org/resource/image/9b/9d/9ba06fe485a85cafea2958f9eb423e9d.gif?wh=600x381)
与我们在第 4 节课中，用 JSX 语法实现的那个对话框组件类似。

- 第一步，实现 Dialog 的实体组件，用 JSX 语法或模板语法都可以。这里，Dialog 组件要用 Emit 方式注册好回调事件；
- 第二步，封装 createDialog 函数来创建一个 Dialog 的实例。这个过程要注意配置好 Dialog 的回调函数等操作；
- 第三步，封装 close 函数来控制卸载关闭这个组件。
  <br/>

  在实现 Vue.js 3.x 动态渲染组件的时候，还有几点需要你多加注意：<br/>

  - 在组件的挂载和卸载过程中，尽量用 Vue.js 3.x 的内置 &lt;transition&gt; 组件来实现动画过渡效果，提升用户体验，减少组件动态显示和消失的突兀感觉。
  - 动态组件在关闭后，注意要记得销毁组件挂载的动态 DOM，释放没必要的内存占用，减少内存泄漏的风险。

> 此文章为 3 月 Day11 学习笔记，内容来源于极客时间《Vue 3 企业级项目实战课》，学习使我快乐，每天进步一点点 💪💪
